<html>
    <head>
        <!-- Loads Bootstrap templates -->
        <link rel="stylesheet" href="/static/bootstrap.min.css">
        <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <link rel="stylesheet" href="/static/main.css">
        </style>
        <!-- Script for the Visual of the Timeline -->
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <!-- Fonts StyleSheet used to load google fonts -->
        <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|Quicksand|Quicksand:700" rel="stylesheet">
    </head>
    <body>
        <form class="form-inline global-search" onsubmit= "preloader()">

            <h1 id = "logo"> Informd</h1> <br style = "line-height: 25%">
            <h2 id = "subtitle"> the evolution of news </h2>
            <br><br>
            <div class="form-group">
                <input id="input" type="text" name="search" class="form-control" placeholder="Tell me about: Israeli-Palestine Conflict">
            </div>
            <button type="submit" class="btn btn-info" id = "search_button"> Search </button>
            <br> <br>   
            <button id = "advanced_search" type="button" class="btn btn-info btn-sm">advanced search</button>
            <br>


            <div id = "advanced_search_div" style ="display:none">
                <!-- Parameter Set for Sorting the Search Results -->
                <fieldset class="form-group">
                <legend>Sort Timeline Order by</legend>
                <div class="form-check">
                  <label class="form-check-label">
                    <input type="radio" class="form-check-input" name="sort_order" id="optionsRadios1" value="option1" checked> 
                    <!-- By default this is set to reverse chronological -->
                    Reverse Chronological
                  </label>
                </div>
                <br>
                <div class="form-check">
                <label class="form-check-label">
                    <input type="radio" class="form-check-input" name="sort_order" id="optionsRadios2" value="option2">
                    Chronological
                  </label>
                </div>
                <br>
                <div class="form-check-label">
                <label class="form-check-label">
                    <input type="radio" class="form-check-input" name="sort_order" id="optionsRadios3" value="option3">
                    Most Relevant --> Least Relevant 
                  </label>
                </div>
                </fieldset>
            </div>
        </form>



        <div id="loading" style="display: none;">
            <div class = "loader"> </div>
        </div>

        <div id = "all_results">    <!-- Used to contain all 
            the results so they are hidden with new search -->
            <h3 id = "search_result" >{{output_message}}</h3>
            <div id= "timegraph"> 
                <svg id = "svg_graph"></svg>
                <br>
            </div>


            <div class= "timeline" id ="timeline0">     <br>
                {% for d in data %}
                    {% if data.index(d) % 2 != 0 %}
                        <div class="container left">
                            <div class="content">
                                {% for x in d[1] %}
                                        {% if d[4] == "nope" %}
                                            <div class="container_header">
                                                <div class="date"> <p id = "date1"> {{d[0]}} <p> </div> 
                                                <div class="score"> 
                                                    <p id= heat>  {{d[3]}} </p>
                                                    <img id="icon" src="static/images/light.png">
                                                </div>
                                            </div>
                                            <br><br>
                                            <div id = "p2"> {{x}} </div>
                                        {%else %}

                                        <div class="container_header">
                                                <div class="date"> <p id = "date1"> {{d[0]}} <p> </div> 
                                                <div class="score"> 
                                                    <p id= heat>  {{d[3]}} </p>
                                                    <img id="icon2" src="static/images/reddit.png">
                                                    <img id="icon" src="static/images/light.png">
                                                </div>
                                            </div>
                                            <br><br>

                                            <div id="p2"> <a href="{{d[4]}}"> {{x}}</a></div>
                                        {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="container right">
                            <div class="content">

                                {% for x in d[1] %}
                                        {% if d[4] == "nope" %}
                                            <div class="container_header">
                                                <div class="date"> <p id = "date1"> {{d[0]}} <p> </div> 
                                                <div class="score"> 
                                                    <p id= heat>  {{d[3]}} </p>
                                                    <img id="icon" src="static/images/light.png">
                                                </div>
                                            </div>
                                            <br><br>

                                            <div id = "p2"> {{x}} </div>
                                        {%else %}

                                        <div class="container_header">
                                                <div class="date"> <p id = "date1"> {{d[0]}} <p> </div> 
                                                <div class="score"> 
                                                    <p id= heat>  {{d[3]}} </p>
                                                    <img id="icon2" src="static/images/reddit.png">
                                                    <img id="icon" src="static/images/light.png">
                                                </div>
                                            </div>
                                            <br><br>

                                            <div id="p2"> <a href="{{d[4]}}"> {{x}}</a></div>
                                            
                                        {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

            </div>
        </div>
        <br>
        <div id = "bottom_screen_footer" class="footer">
        <p id = "p1">Project Name: {{ name }} || Student Names: {{ netid }}</p>
        </div>
    </body>

<!--  ____________________________________________________________________________ -->

    <script>
        function preloader(){
            console.log("called preloader");
            old_results = document.getElementById("all_results");
            old_results.style.display = "none"
            loading_div = document.getElementById("loading");
            loading_div.style.display= "block";
            footer0 = document.getElementById("bottom_screen_footer");
            footer0.style.display = "block";
            timeline = document.getElementById("timeline0");
            console.log(timeline);
            timeline.style.display = "block";
        }

        // Opens advanced search menu on click.
        $('#advanced_search').on('click', function(event) {
            advanced_search_div = document.getElementById("advanced_search_div");
            if  (advanced_search_div.style.display == "block"){
                advanced_search_div.style.display = "none"
            }
            else {
                advanced_search_div.style.display = "block";
            }
        });
            
        function plotGraph(xdata, ydata){
            // console.log(xdata, ydata);

            var data_final = xdata.map(function(d, i){
                return { 'date' : Number(d), 'reddit_score' : Number(ydata[i])};
            });

            var padding = 15;       // allows you to put axis labels
            var height = 225;       // may need to modify
            var width = 650;

            
            var svg = d3.select("#svg_graph")      // will need to put the svg within a div.
            .attr("height", height + 2*padding).attr("width", width + 2* padding)
            .append("g");

            // axis
            var xScale = d3.scaleLinear().domain(d3.extent(xdata))   // change from d.date to date int.
            .range([5*padding, width - 2*padding]);

            var yScale = d3.scaleLinear().domain(d3.extent(ydata))  // change from d.value to the reddit score.
            .range([height, 2*padding]);

            // add the axis to the svg.
            svg.append("g").call(d3.axisLeft(yScale)).attr("transform", "translate(" + 5*padding + ", 0)");
            svg.append("g").call(d3.axisBottom(xScale).tickFormat(d3.format("d")).ticks(4))
                .attr("transform", "translate(0," + (height) + ")");

            // svg.append("text").attr("transform", "translate(" + padding + ", 0)").text("Monthly Job Change");
            svg.append("text").attr("transform", "rotate(270) translate(" + width / 2  + "," + height/2 + ")").text("Reddit Score"); // Might need to realign
            svg.append("text").attr("transform", "translate(200, 350)").text("Date");

            // creates the line that connects the points. 
            var line = d3.line()
            .x(function(d) { return xScale(d.date); })    
            .y(function(d) { return yScale(d.reddit_score); });

            // add this line to the graph.
            svg.append("path")
                .attr("d", line(data_final))
                .style("stroke", "#000000")
                .style("fill", "none");

            // svg.append("circle")
            //     .attr("cx", function(d) { return xScale(d.date); })       // change 
            //     .attr("cy", function(d) { return yScale(d.reddit_score); })      // change
            //     .attr("r", 2)     
            //     .style("fill", "black");    // need to check that this color works.
            }

            {% if data %}

                var dates_arr = [];
                var scores_arr = [];
                {% for d in data %}
                    dates_arr.push(String({{(d[2])}}));

                    {% if d[3] == "NA" %}
                        scores_arr.push(String(100));
                    {% else %}
                        scores_arr.push(String({{(d[3])}}));
                    {% endif %}

                 {% endfor %}

                var dates_final = [];
                var scores_final = [];

                for (i = 0; i < dates_arr.length; i++) { 
                    if (scores_arr[i] == "NA"){
                        scores_final.push(Number(100));
                        dates_final.push(Number(dates_arr[i]));
                    }
                    else{
                        scores_final.push(Number(scores_arr[i]));
                        dates_final.push(Number(dates_arr[i]));
                    }
                }
                plotGraph(dates_final, scores_final);
            {% endif %}
    </script>
</html>
